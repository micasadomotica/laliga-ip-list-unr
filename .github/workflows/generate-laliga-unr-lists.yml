name: Generate UNR LaLiga lists (IPv4/IPv6)

on:
  # Se ejecuta cuando cambie laliga_ip_list.txt en main
  push:
    branches: [ main ]
    paths:
      - "laliga_ip_list.txt"

  # Tambi√©n puedes lanzarlo a mano desde la UI de Actions
  workflow_dispatch:

# Evita ejecuciones concurrentes que empujen a main a la vez
concurrency:
  group: laliga-main-writes
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build-unr-lists:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show current laliga_ip_list.txt
        run: |
          if [ ! -s "laliga_ip_list.txt" ]; then
            echo "‚ùå laliga_ip_list.txt not found or empty"
            exit 1
          fi
          echo "‚úÖ laliga_ip_list.txt present, first lines:"
          head -n 20 laliga_ip_list.txt || true

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Generate UNR IPv4/IPv6 lists
        run: |
          echo "üß© Generating UNR lists from laliga_ip_list.txt..."
          node scripts/generate-unr-lists.js

      - name: Commit and push UNR lists
        run: |
          set -e

          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          if [[ -n "$(git status --porcelain)" ]]; then
            git add laliga_ip_list_unr_ipv4.txt laliga_ip_list_unr_ipv6.txt
            git commit -m "Auto-update UNR LaLiga IPv4/IPv6 lists"

            # Reintentos por si el otro workflow empuja a main entre medias
            for attempt in 1 2 3; do
              echo "üîÑ Sync attempt $attempt/3..."

              git fetch origin main

              # Rebase sobre el main remoto (evita non-fast-forward)
              if ! git rebase origin/main; then
                echo "‚ö†Ô∏è Rebase failed, aborting rebase..."
                git rebase --abort || true
                exit 1
              fi

              # Push seguro (no pisa cambios remotos inesperados)
              if git push --force-with-lease origin HEAD:main; then
                echo "‚úÖ Pushed successfully."
                exit 0
              fi

              echo "‚ö†Ô∏è Push failed (likely due to concurrent updates). Retrying..."
              sleep 5
            done

            echo "‚ùå Failed to push after 3 attempts."
            exit 1
          else
            echo "No UNR changes to commit."
          fi
